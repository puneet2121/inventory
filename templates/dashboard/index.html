{% extends 'core/page/full_page.html' %}
{% load static %}
{% load currency %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block page_content %}
<div class="dashboard-container" x-data="dashboardManager">
    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon bg-primary">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="stats-info">
                <h3>{{ total_sales_today|rupee }}</h3>
                <p>Today's Sales</p>
                <div class="stats-trend {% if today_sales_trend >= 0 %}up{% else %}down{% endif %}">
                    <i class="bi bi-arrow-{% if today_sales_trend >= 0 %}up{% else %}down{% endif %}"></i>
                    {{ today_sales_trend }}% vs yesterday
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon bg-success">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div class="stats-info">
                <h3>{{ total_sales_this_month|rupee }}</h3>
                <p>Monthly Sales</p>
                <div class="stats-trend {% if monthly_sales_trend >= 0 %}up{% else %}down{% endif %}">
                    <i class="bi bi-arrow-{% if monthly_sales_trend >= 0 %}up{% else %}down{% endif %}"></i>
                    {{ monthly_sales_trend }}% vs last month
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon bg-info">
                <i class="bi bi-cart-check"></i>
            </div>
            <div class="stats-info">
                <h3>{{ total_orders }}</h3>
                <p>Total Orders</p>
                <div class="stats-trend">
                    {{ orders_today }} orders today
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon bg-warning">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="stats-info">
                <h3>{{ low_stock_count }}</h3>
                <p>Low Stock Items</p>
                <div class="stats-trend">
                    Needs attention
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon bg-secondary">
                <i class="bi bi-people"></i>
            </div>
            <div class="stats-info">
                <h3>{{ total_customers }}</h3>
                <p>Total Customers</p>
                <div class="stats-trend">
                    Active customers
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon bg-dark">
                <i class="bi bi-box"></i>
            </div>
            <div class="stats-info">
                <h3>{{ total_products }}</h3>
                <p>Total Products</p>
                <div class="stats-trend">
                    In inventory
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon bg-purple">
                <i class="bi bi-tags"></i>
            </div>
            <div class="stats-info">
                <h3>{{ total_categories }}</h3>
                <p>Categories</p>
                <div class="stats-trend">
                    Product categories
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon bg-danger">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stats-info">
                <h3>{{ expiring_soon_count }}</h3>
                <p>Expiring in 3 Months</p>
                <div class="stats-trend">
                    Check expiry dates
                </div>
            </div>
        </div>
    </div>


    <!-- Data Tables Section -->
    <div class="tables-grid">
        <!-- Recent Orders -->
        <div class="table-card">
            <div class="table-header">
                <h5>Recent Orders</h5>
                <a href="{% url 'point_of_sale:sales_order_list' %}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount (₹)</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in recent_orders %}
                        <tr>
                            <td>#{{ order.order_number|default:order.id }}</td>
                            <td>{{ order.customer.name|default:"Walk-in Customer" }}</td>
                            <td>{{ order.cached_total|rupee }}</td>
                            <td>
                                <span class="status-badge {{ order.status|lower }}">
                                    {{ order.get_status_display }}
                                </span>
                            </td>
                            <td>{{ order.created_at|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No recent orders</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Low Stock Items -->
        <div class="table-card">
            <div class="table-header">
                <h5>Low Stock Items</h5>
                <a href="{% url 'inventory:item_list' %}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Location</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inventory in low_stock_items %}
                        <tr>
                            <td>{{ inventory.product.name }}</td>
                            <td>{{ inventory.product.category.name|default:"Uncategorized" }}</td>
                            <td>
                                <span class="stock-badge low">
                                    {{ inventory.quantity }}
                                </span>
                            </td>
                            <td>{{ inventory.location }}</td>
                            <td>
                                <a href="{% url 'inventory:edit_product' inventory.product.id %}" class="btn btn-sm btn-light">
                                    Update Stock
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No low stock items</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expiring Soon Items (<= 90 days) -->
        <div class="table-card">
            <div class="table-header">
                <h5>Expiring Soon (≤ 90 days)</h5>
                <a href="{% url 'inventory:item_list' %}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Expiry Date</th>
                            <th>Days Left</th>
                            <th>Stock</th>
                            <th>Location</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in expiring_soon_items %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.product.category.name|default:"Uncategorized" }}</td>
                            <td>{{ item.product.expiry_date|date:"Y-m-d" }}</td>
                            <td>
                                {% if item.days_left is not None %}
                                    {% if item.days_left <= 0 %}
                                        <span class="badge bg-danger">Expired</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">{{ item.days_left }} days</span>
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ item.inventory.quantity|default:0 }}</td>
                            <td>{{ item.inventory.location|default:"-" }}</td>
                            <td>
                                <a href="{% url 'inventory:edit_product' item.product.id %}" class="btn btn-sm btn-light">
                                    Update
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No items expiring in the next 90 days</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}