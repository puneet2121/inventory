{% load humanize %}

<div class="row mb-4">
    <!-- Summary Cards -->
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Total Sales</h6>
                <h3 class="card-title">₹{{ report_data.total_sales|floatformat:2|intcomma }}</h3>
                <p class="card-text small text-muted mb-0">
                    {{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Total Orders</h6>
                <h3 class="card-title">{{ report_data.total_orders|intcomma }}</h3>
                <p class="card-text small text-muted mb-0">
                    Completed orders in period
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Avg. Order Value</h6>
                <h3 class="card-title">
                    ₹{{ report_data.total_orders|div:report_data.total_orders|floatformat:2|intcomma }}
                </h3>
                <p class="card-text small text-muted mb-0">
                    Average revenue per order
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sales by Day Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">Daily Sales</h6>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Sales by Status -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">Sales by Status</h6>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for status in report_data.sales_by_status %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="text-capitalize">{{ status.status }}</span>
                        <div class="d-flex flex-column text-end">
                            <span>₹{{ status.total|floatformat:2|intcomma }}</span>
                            <small class="text-muted">{{ status.count }} orders</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Selling Products -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Top Selling Products</h6>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Barcode</th>
                    <th class="text-end">Quantity</th>
                    <th class="text-end">Revenue</th>
                </tr>
            </thead>
            <tbody>
                {% for product in report_data.top_products %}
                <tr>
                    <td>{{ product.product__name|default:"Unknown Product" }}</td>
                    <td>{{ product.product__barcode|default:"-" }}</td>
                    <td class="text-end">{{ product.total_quantity|floatformat:0|intcomma }}</td>
                    <td class="text-end">₹{{ product.total_revenue|floatformat:2|intcomma }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-4">No sales data available for the selected period</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Sales by Category -->
<div class="card">
    <div class="card-header">
        <h6 class="mb-0">Sales by Category</h6>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Category</th>
                    <th class="text-end">Quantity</th>
                    <th class="text-end">Revenue</th>
                </tr>
            </thead>
            <tbody>
                {% for category in report_data.sales_by_category %}
                <tr>
                    <td>{{ category.product__category__name|default:"Uncategorized" }}</td>
                    <td class="text-end">{{ category.total_quantity|floatformat:0|intcomma }}</td>
                    <td class="text-end">₹{{ category.total_sales|floatformat:2|intcomma }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center py-4">No category data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% block extra_js %}
<script>
// Initialize sales chart
const ctx = document.getElementById('salesChart').getContext('2d');
const salesChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for day in report_data.sales_by_day %}'{{ day.date|date:"M d" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Daily Sales',
            data: [{% for day in report_data.sales_by_day %}{{ day.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '₹' + context.raw.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '₹' + value.toLocaleString('en-IN', {maximumFractionDigits: 0});
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
