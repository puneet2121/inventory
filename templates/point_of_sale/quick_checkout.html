{% extends 'core/page/full_page.html' %}

{% block page_content %}
<div class="container mt-3" x-data="quickCheckout()">
    <!-- Lightweight toast/alert -->
    <div class="alert alert-danger position-fixed top-0 end-0 m-3 shadow" x-show="toast.show" x-text="toast.message" x-transition></div>
    <h2 class="mb-4">Quick Checkout</h2>

    <!-- Barcode Scanner Section -->
    <div class="mb-4">
        <button class="btn btn-primary btn-lg w-100 mb-2" @click="startScanner" :disabled="scannerActive">
            Open Barcode Scanner (Ctrl+B)
        </button>
        <div id="barcode-scanner" class="d-none">
            <div id="interactive" class="viewport"></div>
            <button class="btn btn-danger btn-lg w-100 mt-2" @click="stopScanner">
                Close Scanner (Esc)
            </button>
        </div>
    </div>

    <!-- Barcode Input (Manual Entry) -->
    <div class="mb-4">
        <input type="text"
               class="form-control form-control-lg"
               placeholder="Scan Barcode or Enter Manually"
               x-model="barcode"
               @keyup.enter="addItem"
               autofocus>
    </div>

    <!-- Quantity Input -->
    <div class="row mb-4" x-show="currentProduct">
        <div class="col-12">
            <input type="number"
                   class="form-control form-control-lg"
                   placeholder="Enter Quantity"
                   x-model="quantity"
                   min="1"
                   value="1"
                   @keyup.enter="addToCart">
            <button class="btn btn-success btn-lg w-100 mt-2" @click="addToCart">
                Add to Cart
            </button>
        </div>
    </div>

    <!-- Cart Items -->
    <div class="card mb-3">
        <div class="card-body">
            <template x-for="(item, index) in cart" :key="index">
                <div class="row align-items-center mb-2">
                    <div class="col-5">
                        <span x-text="item.product.name"></span>
                    </div>
                    <div class="col-3">
                        <input type="number"
                               class="form-control"
                               x-model="item.quantity"
                               min="1"
                               @change="updateTotal">
                    </div>
                    <div class="col-3">
                        ₹<span x-text="(item.product.price * item.quantity).toFixed(2)"></span>
                    </div>
                    <div class="col-1">
                        <button class="btn btn-danger btn-sm"
                                @click="removeItem(index)">
                            X
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Checkout Section -->
    <div class="fixed-bottom bg-white p-3 border-top">
        <div class="d-flex justify-content-between align-items-center">
            <h3>Total: ₹<span x-text="total.toFixed(2)"></span></h3>
            <form method="post" @submit.prevent="checkout">
                {% csrf_token %}
                <input type="hidden" name="cart_data" :value="JSON.stringify(cart)">
                <select name="payment_status" class="form-select me-2" required>
                    <option value="paid">Paid Now</option>
                    <option value="unpaid">Pay Later</option>
                </select>
                <button type="submit" class="btn btn-success btn-lg" :disabled="isSubmitting || cart.length===0">
                    <span x-show="!isSubmitting">Complete Checkout (Enter)</span>
                    <span x-show="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span x-show="isSubmitting">Processing...</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Include QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
function quickCheckout() {
    return {
        barcode: '',
        quantity: 1,
        currentProduct: null,
        cart: [],
        total: 0,
        isSubmitting: false,
        scannerActive: false,
        toast: { show: false, message: '' },

        init() {
            this.loadCart();
            // Global keyboard shortcuts
            window.addEventListener('keydown', (e) => this.handleKeys(e));
        },

        showError(msg) {
            this.toast.message = msg;
            this.toast.show = true;
            setTimeout(() => { this.toast.show = false; }, 2500);
        },

        persistCart() {
            try { localStorage.setItem('qc_cart', JSON.stringify(this.cart)); } catch (e) {}
        },
        loadCart() {
            try {
                const raw = localStorage.getItem('qc_cart');
                if (raw) {
                    this.cart = JSON.parse(raw);
                    this.updateTotal();
                }
            } catch (e) {}
        },

        handleKeys(e) {
            // Toggle scanner with Ctrl+B
            if (e.ctrlKey && (e.key === 'b' || e.key === 'B')) {
                e.preventDefault();
                this.scannerActive ? this.stopScanner() : this.startScanner();
            }
            // Close scanner with Escape
            if (e.key === 'Escape' && this.scannerActive) {
                e.preventDefault();
                this.stopScanner();
            }
            // Quick quantity adjust while selecting current product
            if (this.currentProduct) {
                if (e.key === '+') { this.quantity = parseInt(this.quantity || 1) + 1; }
                if (e.key === '-' && this.quantity > 1) { this.quantity = parseInt(this.quantity) - 1; }
            }
        },

        // Utility debounce for network calls
        _debounceTimer: null,
        debounce(fn, delay = 200) {
            return (...args) => {
                clearTimeout(this._debounceTimer);
                this._debounceTimer = setTimeout(() => fn.apply(this, args), delay);
            };
        },

        async addItem() {
            if (!this.barcode) return;

            try {
                const response = await fetch(`/point_of_sale/api/products/${this.barcode}/`);
                const product = await response.json();
                this.currentProduct = product;
                this.quantity = 1;  // Reset quantity
            } catch (error) {
                this.showError('Product not found!');
                this.barcode = '';
            }
        },

        addToCart() {
            if (!this.currentProduct || this.quantity < 1) return;

            const existingItem = this.cart.find(item =>
                item.product.id === this.currentProduct.id
            );

            if (existingItem) {
                existingItem.quantity += parseInt(this.quantity);
            } else {
                this.cart.push({
                    product: this.currentProduct,
                    quantity: parseInt(this.quantity)
                });
            }

            this.barcode = '';
            this.currentProduct = null;
            this.updateTotal();
            this.persistCart();
        },

        removeItem(index) {
            this.cart.splice(index, 1);
            this.updateTotal();
            this.persistCart();
        },

        updateTotal() {
            this.total = this.cart.reduce((sum, item) =>
                sum + (item.product.price * item.quantity), 0
            );
            // Keep hidden input in sync if any other code reads it
            this.persistCart();
        },

        checkout() {
            if (this.cart.length === 0) {
                this.showError('Please add items to cart!');
                return;
            }
            this.isSubmitting = true;
            this.$el.submit();
        },

        startScanner() {
            const scannerDiv = document.getElementById('barcode-scanner');
            scannerDiv.classList.remove('d-none');
            this.scannerActive = true;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Use rear camera
                    },
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader"] // Supported barcode formats
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    // Surface a friendly error and bail
                    document.dispatchEvent(new CustomEvent('qc:error', { detail: 'Scanner failed to initialize' }));
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected((data) => {
                this.barcode = data.codeResult.code;
                this.addItem();
                this.stopScanner();
            });
        },

        stopScanner() {
            Quagga.stop();
            const scannerDiv = document.getElementById('barcode-scanner');
            scannerDiv.classList.add('d-none');
            this.scannerActive = false;
        }
    }
}
</script>

<style>
#interactive {
    width: 100%;
    height: 300px;
    position: relative;
    overflow: hidden;
    border: 2px solid #ccc;
    border-radius: 8px;
}

.viewport {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}
</style>
{% endblock %}