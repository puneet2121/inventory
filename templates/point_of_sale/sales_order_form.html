{% extends 'core/page/full_page.html' %}

{% block page_content %}
{% if formset.non_form_errors %}
    <div class="alert alert-danger">
        <ul>
            {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="container mt-5" x-data="salesOrderApp()">
    <h1>Create Sales Order</h1>

    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="customer" class="form-label">Customer</label>
            {{ sales_order_form.customer }}
        </div>
        <div class="mb-3">
            <label for="customer_name" class="form-label">Customer Name</label>
            {{ sales_order_form.customer_name }}
        </div>
        <div class="mb-3">
            <label for="customer_type" class="form-label">Customer Type</label>
            {{ sales_order_form.customer_type }}
        </div>
        <div class="mb-3">
            <label for="employee" class="form-label">Salesperson</label>
            {{ sales_order_form.employee }}
        </div>

        <!-- Add Paid/Unpaid Field -->
        <div class="mb-3">
            <label for="payment_status" class="form-label">Payment Status</label>
            <select name="payment_status" id="payment_status" class="form-select" required>
                <option value="unpaid">Unpaid</option>
                <option value="paid">Paid</option>
            </select>
        </div>

        <hr>

        <h3>Order Items</h3>

        <!-- Render the formset's management form -->
        {{ formset.management_form }}

        <!-- Render each order item form -->
        <template x-for="(item, index) in items" :key="index">
            <div class="row align-items-center mb-3">
                <div class="col-md-4">
                    <label :for="'barcode-' + index" class="form-label">Barcode</label>
                    <input :name="'items-' + index + '-barcode'" type="text" class="form-control"
                           :id="'barcode-' + index" x-model="item.barcode" @input="findProductByBarcode(index)">
                </div>
                <div class="col-md-4">
                    <label :for="'product-' + index" class="form-label">Product</label>
                    <select :name="'items-' + index + '-product'" class="form-select" :id="'product-' + index" x-model="item.product" @change="updatePrice(index)">
                        <option value="">Select a product</option>
                        {% for product in products %}
                        <option :value="{{ product.id }}" :data-price="{{ product.price }}" :data-barcode="{{ product.barcode }}" x-bind:selected="item.product == '{{ product.id }}'">
                            {{ product.name }} - ${{ product.price }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label :for="'quantity-' + index" class="form-label">Quantity</label>
                    <input :name="'items-' + index + '-quantity'" type="number" class="form-control"
                           :id="'quantity-' + index" x-model="item.quantity" @input="updateTotal">
                </div>
                <div class="col-md-2">
                    <label :for="'price-' + index" class="form-label">Price</label>
                    <input :name="'items-' + index + '-price'" type="number" class="form-control"
                           :id="'price-' + index" x-model="item.price" readonly>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger mt-4" @click="removeItem(index)">X</button>
                </div>
            </div>
        </template>

        <!-- Add new order item -->
        <button type="button" class="btn btn-primary" @click="addItem">Add Item</button>

        <!-- Display Total -->
        <div class="mt-3">
            <strong>Total: $<span x-text="total.toFixed(2)"></span></strong>
        </div>

        <!-- Submit button -->
        <div class="mt-3">
            <button type="submit" class="btn btn-success">Create Sales Order</button>
        </div>
    </form>
</div>

<script>
    function salesOrderApp() {
        return {
            items: [
                {% for form in formset %}
                {
                    product: "{{ form.initial.product|default_if_none:'' }}",
                    quantity: "{{ form.initial.quantity|default_if_none:'' }}",
                    price: "{{ form.initial.price|default_if_none:'' }}",
                    barcode: "{{ form.initial.barcode|default_if_none:'' }}"
                },
                {% endfor %}
            ],
            total: 0,
            addItem() {
                // Add a new empty item
                this.items.push({ product: "", quantity: "", price: "", barcode: "" });
                // Update the TOTAL_FORMS field in the formset management form
                this.updateFormsetCount();
            },
            removeItem(index) {
                // Remove the item at the specified index
                this.items.splice(index, 1);
                // Update the TOTAL_FORMS field in the formset management form
                this.updateFormsetCount();
                // Recalculate the total
                this.updateTotal();
            },
            updatePrice(index) {
                const selectedProduct = this.items[index].product;
                const productElement = document.querySelector(`[name="items-${index}-product"]`);
                const selectedOption = productElement.querySelector(`option[value="${selectedProduct}"]`);
                if (selectedOption) {
                    this.items[index].price = selectedOption.getAttribute('data-price');
                }
                this.updateTotal();
            },
            updateTotal() {
                this.total = this.items.reduce((sum, item) => {
                    return sum + (item.quantity * item.price);
                }, 0);
            },
            updateFormsetCount() {
                // Update the TOTAL_FORMS field in the formset management form
                const totalFormsInput = document.querySelector('[name="items-TOTAL_FORMS"]');
                if (totalFormsInput) {
                    totalFormsInput.value = this.items.length;
                }
            },
            findProductByBarcode(index) {
                const barcode = this.items[index].barcode;
                const productElement = document.querySelector(`[name="items-${index}-product"]`);
                const options = productElement.querySelectorAll('option');
                let found = false;

                options.forEach(option => {
                    if (option.getAttribute('data-barcode') === barcode) {
                        this.items[index].product = option.value;
                        this.updatePrice(index);
                        found = true;
                    }
                });

                if (!found) {
                    this.items[index].product = "";
                    this.items[index].price = "";
                    this.updateTotal();
                }
            }
        }
    }
</script>
{% endblock %}