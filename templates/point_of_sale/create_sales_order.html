{% extends 'core/page/full_page.html' %}
{% load static %}

{% block title %}Create Sales Order{% endblock %}

{% block extra_css %}
<style>
    .item-row {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #e9ecef;
    }
    
    .product-dropdown {
        position: relative;
    }
    
    .product-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-option {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .product-option:hover {
        background-color: #f8f9fa;
    }
    
    .order-summary {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        position: sticky;
        top: 20px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 5px 0;
    }
    
    .summary-row.total {
        border-top: 2px solid #007bff;
        padding-top: 15px;
        margin-top: 15px;
        font-weight: bold;
        font-size: 1.2em;
    }
    
    .btn-remove {
        color: #dc3545;
        border: none;
        background: none;
        padding: 5px 10px;
        border-radius: 4px;
    }
    
    .btn-remove:hover {
        background-color: #f8d7da;
    }
    
    .customer-form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }
    
    .order-number {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
        color: #1976d2;
        margin-bottom: 20px;
    }

    .customer-search-results {
        position: relative;
    }
    .customer-results-dropdown {
        position: absolute;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        max-height: 220px;
        overflow-y: auto;
        z-index: 1000;
    }
    .customer-option { padding: 8px 10px; cursor: pointer; }
    .customer-option:hover { background: #f8f9fa; }
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid py-4" x-data="salesOrderApp()">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-cart-plus me-2"></i>Create Sales Order
                </h2>
                <div class="order-number" x-show="orderNumber">
                    Order #: <span x-text="orderNumber"></span>
                </div>
            </div>
        </div>
    </div>

    <form method="post" @submit="handleSubmit">
        {% csrf_token %}

        <div class="row">
            <!-- Left Column - Form Data -->
            <div class="col-lg-8">
                <!-- Customer Information -->
                <div class="customer-form-section">
                    <h5 class="form-section-title">Customer Information</h5>
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Search Customer</label>
                            <div class="customer-search-results">
                                <input type="text" class="form-control" placeholder="Search by name, phone, or shop..." x-model="customerSearch" @input="searchCustomers" @focus="showCustomerResults = true">
                                <div class="customer-results-dropdown" x-show="showCustomerResults && customerResults.length > 0" @click.away="showCustomerResults = false">
                                    <template x-for="c in customerResults" :key="c.id">
                                        <div class="customer-option" @click="selectCustomer(c)">
                                            <strong x-text="c.name"></strong>
                                            <small class="text-muted"> - <span x-text="c.contact || 'N/A'"></span> • <span x-text="c.shop || c.city || ''"></span></small>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <!-- Hidden field to submit customer id -->
                            <input type="hidden" name="customer" :value="selectedCustomer">
                            <!-- original select removed to avoid duplicate name submission -->
                        </div>
                        <div class="col-12">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Quick Add Name</label>
                                    <input type="text" class="form-control" x-model="quickAdd.name" placeholder="Customer name">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Phone</label>
                                    <input type="text" class="form-control" x-model="quickAdd.contact" placeholder="Optional">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" x-model="quickAdd.city" placeholder="Optional">
                                </div>
                                <div class="col-md-2 d-grid">
                                    <button type="button" class="btn btn-outline-primary" @click="quickCreateCustomer">Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="{{ sales_order_form.employee.id_for_label }}" class="form-label">Salesperson</label>
                            {{ sales_order_form.employee }}
                        </div>
                        <div class="col-12">
                            <label for="{{ sales_order_form.note.id_for_label }}" class="form-label">Notes</label>
                            {{ sales_order_form.note }}
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Order Items</h5>
                        <button type="button" class="btn btn-primary btn-sm" @click="addItem()">
                            <i class="bi bi-plus"></i> Add Item
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Item Template -->
                        <template x-for="(item, index) in items" :key="index">
                            <div class="item-row">
                                <div class="row align-items-center">
                                    <!-- Product Search -->
                                    <div class="col-md-4">
                                        <label class="form-label">Product</label>
                                        <div class="product-dropdown">
                                            <input
                                                type="text"
                                                class="form-control"
                                                x-model="item.productSearch"
                                                @input="searchProducts(index)"
                                                @focus="item.showResults = true"
                                                :placeholder="item.product ? item.product.name : 'Search by name or barcode...'"
                                            >
                                            <div class="product-search-results"
                                                 x-show="item.showResults && item.searchResults.length > 0"
                                                 @click.away="item.showResults = false">
                                                <template x-for="product in item.searchResults" :key="product.id">
                                                    <div class="product-option" @click="selectProduct(index, product)">
                                                        <strong x-text="product.name"></strong><br>
                                                        <small>Price: ₹<span x-text="product.price"></span> | Barcode: <span x-text="product.barcode"></span></small>
                                                    </div>
                                                </template>
                                            </div>
                                            <!-- Hidden input for form submission -->
                                            <input type="hidden" :name="'items-' + index + '-product'" :value="item.product ? item.product.id : ''">
                                        </div>
                                    </div>

                                    <!-- Quantity -->
                                    <div class="col-md-2">
                                        <label class="form-label">Quantity</label>
                                        <input
                                            type="number"
                                            class="form-control"
                                            x-model="item.quantity"
                                            @input="updateRowTotal(index)"
                                            :name="'items-' + index + '-quantity'"
                                            min="1"
                                            step="1"
                                        >
                                    </div>

                                    <!-- Price -->
                                    <div class="col-md-2">
                                        <label class="form-label">Price</label>
                                        <input
                                            type="number"
                                            class="form-control"
                                            x-model="item.price"
                                            @input="updateRowTotal(index)"
                                            :name="'items-' + index + '-price'"
                                            step="0.01"
                                            min="0"
                                        >
                                    </div>

                                    <!-- Amount -->
                                    <div class="col-md-2">
                                        <label class="form-label">Amount</label>
                                        <div class="form-control-plaintext fw-bold">
                                            ₹<span x-text="(item.quantity * item.price).toFixed(2)"></span>
                                        </div>
                                    </div>

                                    <!-- Remove Button -->
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button type="button" class="btn btn-remove w-100" @click="removeItem(index)" x-show="items.length > 1">
                                                <i class="bi bi-trash"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Management Form (required for Django formsets) -->
                        <input type="hidden" name="items-TOTAL_FORMS" :value="items.length">
                        <input type="hidden" name="items-INITIAL_FORMS" value="0">
                        <input type="hidden" name="items-MIN_NUM_FORMS" value="0">
                        <input type="hidden" name="items-MAX_NUM_FORMS" value="1000">
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h5 class="mb-3">Order Summary</h5>

                    <div class="summary-row">
                        <span>Items:</span>
                        <span x-text="items.length"></span>
                    </div>

                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>₹<span x-text="subtotal().toFixed(2)"></span></span>
                    </div>

                    <div class="summary-row">
                        <span>Tax (0%):</span>
                        <span>₹<span x-text="tax().toFixed(2)"></span></span>
                    </div>

                    <div class="summary-row total">
                        <span>Total:</span>
                        <span>₹<span x-text="total().toFixed(2)"></span></span>
                    </div>

                    <hr>

                    <div class="d-grid gap-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="set_in_transit" name="set_in_transit">
                            <label class="form-check-label" for="set_in_transit">
                                Mark as In-Transit (Wholesale only)
                            </label>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg" :disabled="items.length === 0 || !isFormValid">
                            <i class="bi bi-check-circle"></i> Create Order
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @click="resetForm()">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('alpine:init', () => {
    Alpine.data('salesOrderApp', () => ({
        selectedCustomer: '',
        customerSearch: '',
        customerResults: [],
        showCustomerResults: false,
        quickAdd: { name: '', contact: '', city: '' },
        orderNumber: '',
        items: [
            {
                product: null,
                productSearch: '',
                quantity: 1,
                price: 0,
                showResults: false,
                searchResults: []
            }
        ],
        products: (() => {
            try {
                const productsData = JSON.parse('{{ products|escapejs }}');
                return productsData || [];
            } catch (e) {
                console.error('Error parsing products data:', e);
                return [];
            }
        })(),
        searchTimeout: null,

        init() {
            this.generateOrderNumber();
        },

        generateOrderNumber() {
            const timestamp = Date.now();
            this.orderNumber = `SO-${timestamp.toString().slice(-8)}`;
        },

        async searchCustomers() {
            const q = this.customerSearch.trim();
            if (q.length < 2) { this.customerResults = []; return; }
            try {
                const url = new URL('{% url "customers:customers_search" %}', window.location.origin);
                url.searchParams.set('query', q);
                const res = await fetch(url);
                if (!res.ok) return;
                const data = await res.json();
                this.customerResults = data.results || [];
            } catch (e) { console.error(e); }
        },

        selectCustomer(c) {
            this.selectedCustomer = c.id;
            this.customerSearch = `${c.name} (${c.contact || 'N/A'})`;
            this.showCustomerResults = false;
        },

        async quickCreateCustomer() {
            if (!this.quickAdd.name.trim()) { alert('Name is required'); return; }
            const form = new FormData();
            form.append('name', this.quickAdd.name);
            if (this.quickAdd.contact) form.append('contact', this.quickAdd.contact);
            if (this.quickAdd.city) form.append('city', this.quickAdd.city);
            try {
                const res = await fetch('{% url "customers:customers_quick_create" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: form
                });
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Failed to create customer'); return; }
                this.selectCustomer(data);
                // Clear quick add
                this.quickAdd = { name: '', contact: '', city: '' };
            } catch (e) { console.error(e); alert('Failed to create customer'); }
        },

        searchProducts(itemIndex) {
            const query = this.items[itemIndex].productSearch.toLowerCase();

            if (query.length < 2) {
                this.items[itemIndex].searchResults = [];
                return;
            }

            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }

            this.searchTimeout = setTimeout(() => {
                this.items[itemIndex].searchResults = this.products.filter(product =>
                    product.name.toLowerCase().includes(query) ||
                    product.barcode.toLowerCase().includes(query) ||
                    (product.model && product.model.toLowerCase().includes(query))
                ).slice(0, 10);
            }, 300);
        },

        selectProduct(itemIndex, product) {
            this.items[itemIndex].product = product;
            this.items[itemIndex].productSearch = product.name;
            this.items[itemIndex].price = parseFloat(product.price);
            this.items[itemIndex].showResults = false;
            this.items[itemIndex].searchResults = [];
            this.updateRowTotal(itemIndex);
        },

        addItem() {
            this.items.push({
                product: null,
                productSearch: '',
                quantity: 1,
                price: 0,
                showResults: false,
                searchResults: []
            });
        },

        removeItem(index) {
            if (this.items.length > 1) {
                this.items.splice(index, 1);
            }
        },

        updateRowTotal(index) {},
        subtotal() { return this.items.reduce((s, it) => s + (it.quantity * it.price || 0), 0); },
        tax() { return 0; },
        total() { return this.subtotal() + this.tax(); },
        get isFormValid() { return !!this.selectedCustomer && this.items.every(i => i.product && i.quantity > 0 && i.price > 0); },

        handleSubmit(event) {
            if (!this.isFormValid) {
                event.preventDefault();
                alert('Please select a customer and add at least one valid item.');
            }
        },

        resetForm() {
            if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                this.selectedCustomer = '';
                this.customerSearch = '';
                this.customerResults = [];
                this.items = [{ product: null, productSearch: '', quantity: 1, price: 0, showResults: false, searchResults: [] }];
            }
        }
    }));
});
</script>
{% endblock %}
