{#{% extends 'core/page/full_page.html' %}#}
{#{% block page_content %}#}
{#<div class="container mt-5" x-data="salesOrder()">#}
{#<form method="post">#}
{#{% csrf_token %}#}
{#        <h2 class="mb-4">Point of Sale (POS) - Sales Order</h2>#}
{##}
{#        <!-- Walk-in or Existing Customer -->#}
{#        <div class="card mb-4">#}
{#            <div class="card-header">Customer Information</div>#}
{#            <div class="card-body">#}
{#                <div class="form-check form-check-inline">#}
{#                    <input class="form-check-input" type="radio" id="walkInCustomer" value="walk-in" x-model="customerType">#}
{#                    <label class="form-check-label" for="walkInCustomer">Walk-in Customer</label>#}
{#                </div>#}
{#                <div class="form-check form-check-inline">#}
{#                    <input class="form-check-input" type="radio" id="existingCustomer" value="existing" x-model="customerType">#}
{#                    <label class="form-check-label" for="existingCustomer">Existing Customer</label>#}
{#                </div>#}
{##}
{#                <div x-show="customerType === 'existing'" class="mt-3">#}
{#                    <label for="customerSelect" class="form-label">Select Customer</label>#}
{#                    <select class="form-select" id="customerSelect" x-model="customer" required>#}
{#                        <option value="">-- Choose Customer --</option>#}
{#                        {% for customer in customers %}#}
{#                            <option value="{{ customer.id }}">{{ customer.name }}</option>#}
{#                        {% endfor %}#}
{#                    </select>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <!-- Employee Section -->#}
{#        <div class="card mb-4">#}
{#            <div class="card-header">Employee Details</div>#}
{#            <div class="card-body">#}
{#                <div class="row">#}
{#                    <div class="col-md-6">#}
{#                        <label class="form-label">Employee</label>#}
{#                        <select class="form-select" x-model="selectedEmployee">#}
{#                            <option value="{{ request.user.id }}" selected>{{ request.user.username }} (Logged In)</option>#}
{#                            {% for employee in employees %}#}
{#                                {% if employee.id != request.user.id %}#}
{#                                    <option value="{{ employee.id }}">{{ employee.name }}</option>#}
{#                                {% endif %}#}
{#                            {% endfor %}#}
{#                        </select>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <!-- Add Products Section -->#}
{#        <div class="card mb-4">#}
{#            <div class="card-header">Add Products</div>#}
{#            <div class="card-body">#}
{#                <div class="row mb-3">#}
{#                    <div class="col-md-4">#}
{#                        <label class="form-label">Select Product</label>#}
{#                        <select class="form-select" x-model="newItem.product" @change="updateProductPrice">#}
{#                            <option value="">-- Choose Product --</option>#}
{#                            <option value="custom">Add Custom Product</option>#}
{#                            {% for product in products %}#}
{#                                <option value="{{ product.id }}" x-bind:data-price="{{ product.price }}">#}
{#                                    {{ product.name }}#}
{#                                </option>#}
{#                            {% endfor %}#}
{#                        </select>#}
{#                    </div>#}
{#                    <div class="col-md-2">#}
{#                        <label class="form-label">Price</label>#}
{#                        <input type="number" class="form-control" x-model.number="newItem.price" placeholder="0.00">#}
{#                    </div>#}
{#                    <div class="col-md-2">#}
{#                        <label class="form-label">Quantity</label>#}
{#                        <input type="number" class="form-control" x-model.number="newItem.quantity" min="1" placeholder="1">#}
{#                    </div>#}
{#                    <div class="col-md-2 d-flex align-items-end">#}
{#                        <button class="btn btn-success" @click="addProduct">Add Product</button>#}
{#                    </div>#}
{#                </div>#}
{##}
{#                <!-- Product Table -->#}
{#                <table class="table table-bordered">#}
{#                    <thead>#}
{#                        <tr>#}
{#                            <th>Product</th>#}
{#                            <th>Price</th>#}
{#                            <th>Quantity</th>#}
{#                            <th>Total</th>#}
{#                            <th>Action</th>#}
{#                        </tr>#}
{#                    </thead>#}
{#                    <tbody>#}
{#                        <template x-for="(item, index) in items" :key="index">#}
{#                            <tr>#}
{#                                <td x-text="item.name"></td>#}
{#                                <td x-text="item.price.toFixed(2)"></td>#}
{#                                <td x-text="item.quantity"></td>#}
{#                                <td x-text="(item.price * item.quantity).toFixed(2)"></td>#}
{#                                <td>#}
{#                                    <button class="btn btn-danger btn-sm" @click="removeProduct(index)">Remove</button>#}
{#                                </td>#}
{#                            </tr>#}
{#                        </template>#}
{#                    </tbody>#}
{#                </table>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <!-- Payment Status -->#}
{#        <div class="card mb-4">#}
{#            <div class="card-header">Payment Status</div>#}
{#            <div class="card-body">#}
{#                <div class="row">#}
{#                    <div class="col-md-4">#}
{#                        <label class="form-label">Payment Status</label>#}
{#                        <select class="form-select" x-model="paymentStatus">#}
{#                            <option value="paid">Paid</option>#}
{#                            <option value="partial">Partial Paid</option>#}
{#                            <option value="unpaid">Unpaid</option>#}
{#                        </select>#}
{#                    </div>#}
{#                    <div class="col-md-4">#}
{#                        <label class="form-label">Amount Paid</label>#}
{#                        <input type="number" class="form-control" x-model.number="amountPaid" x-bind:disabled="paymentStatus === 'unpaid'" placeholder="0.00">#}
{#                    </div>#}
{#                </div>#}
{#                <template x-if="paymentStatus === 'unpaid'">#}
{#                    <div class="mt-3">#}
{#                        <label for="debtAmount" class="form-label">Debt Amount</label>#}
{#                        <input type="number" class="form-control" x-model.number="debtAmount" readonly>#}
{#                    </div>#}
{#                </template>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <!-- Final Calculations -->#}
{#        <div class="card mb-4">#}
{#            <div class="card-header">Total</div>#}
{#            <div class="card-body">#}
{#                <div class="row">#}
{#                    <div class="col-md-6">#}
{#                        <label class="form-label">Subtotal</label>#}
{#                        <input type="text" class="form-control" x-model="subtotal" readonly>#}
{#                    </div>#}
{#                    <div class="col-md-6">#}
{#                        <label class="form-label">Total Amount</label>#}
{#                        <input type="text" class="form-control" x-model="totalAmount" readonly>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <div class="d-flex justify-content-end">#}
{#            <button class="btn btn-primary" type="submit">Save Order</button>#}
{#        </div>#}
{#</form>#}
{#    </div>#}
{##}
{#    <script>#}
{#        function salesOrder() {#}
{#            return {#}
{#                customerType: 'walk-in',#}
{#                customer: null,#}
{#                selectedEmployee: '{{ request.user.id }}',#}
{#                newItem: {#}
{#                    product: '',#}
{#                    price: 0,#}
{#                    quantity: 1,#}
{#                },#}
{#                items: [],#}
{#                discount: 0,#}
{#                tax: 0,#}
{#                paymentStatus: 'paid',#}
{#                amountPaid: 0,#}
{#                debtAmount: 0,#}
{#                subtotal: 0,#}
{#                totalAmount: 0,#}
{##}
{#                addProduct() {#}
{#                    const selectedProduct = document.querySelector(`#productSelect option[value="${this.newItem.product}"]`);#}
{#                    const productName = selectedProduct ? selectedProduct.textContent : 'Custom Product';#}
{#                    const price = this.newItem.price || parseFloat(selectedProduct.getAttribute('data-price'));#}
{##}
{#                    this.items.push({#}
{#                        name: productName,#}
{#                        price: price,#}
{#                        quantity: this.newItem.quantity,#}
{#                    });#}
{#                    this.calculateTotals();#}
{#                },#}
{##}
{#                removeProduct(index) {#}
{#                    this.items.splice(index, 1);#}
{#                    this.calculateTotals();#}
{#                },#}
{##}
{#                updateProductPrice() {#}
{#                    const selectedProduct = document.querySelector(`#productSelect option[value="${this.newItem.product}"]`);#}
{#                    if (selectedProduct && selectedProduct.hasAttribute('data-price')) {#}
{#                        this.newItem.price = parseFloat(selectedProduct.getAttribute('data-price'));#}
{#                    }#}
{#                },#}
{##}
{#                calculateTotals() {#}
{#                    let subtotal = 0;#}
{#                    this.items.forEach(item => {#}
{#                        subtotal += item.price * item.quantity;#}
{#                    });#}
{##}
{#                    const discountAmount = (subtotal * this.discount) / 100;#}
{#                    const taxAmount = (subtotal * this.tax) / 100;#}
{##}
{#                    this.subtotal = subtotal;#}
{#                    this.totalAmount = subtotal - discountAmount + taxAmount;#}
{##}
{#                    if (this.paymentStatus === 'unpaid') {#}
{#                        this.debtAmount = this.totalAmount;#}
{#                    } else {#}
{#                        this.debtAmount = 0;#}
{#                    }#}
{#                },#}
{##}
{#            }#}
{#        }#}
{#    </script>#}
{#{% endblock %}#}


{% extends 'core/page/full_page.html' %}
{% block page_content %}
<h2>Create Sales Order</h2>
<form method="POST">
    {% csrf_token %}

    <!-- Sales Order Form -->
    <h3>Sales Order Details</h3>
    {{ form.as_p }}

    <!-- Order Items Formset -->
    <h3>Order Items</h3>
    <table>
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {{ formset.management_form }}
            {% for form in formset %}
            <tr>
                <td>{{ form.item_name }}</td>
                <td>{{ form.quantity }}</td>
                <td>{{ form.rate }}</td>
                <td><span class="amount">0.00</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="button" onclick="addRow()">Add More Items</button>
    <button type="submit">Save Sales Order</button>
</form>

<!-- JS for Adding Rows Dynamically -->
<script>
    function addRow() {
        const formsetPrefix = "{{ formset.prefix }}";
        const table = document.querySelector("tbody");
        const rowCount = table.querySelectorAll("tr").length;
        const emptyForm = `{{ formset.empty_form|escapejs }}`;

        // Replace '__prefix__' with the new form index
        const newRow = emptyForm.replace(/__prefix__/g, rowCount);
        table.insertAdjacentHTML('beforeend', newRow);
    }

    // Update amount dynamically based on quantity and rate
    document.addEventListener('input', function (e) {
        if (e.target.name.includes('quantity') || e.target.name.includes('rate')) {
            const row = e.target.closest('tr');
            const quantity = row.querySelector('input[name*="quantity"]').value;
            const rate = row.querySelector('input[name*="rate"]').value;
            const amount = parseFloat(quantity) * parseFloat(rate) || 0.00;
            row.querySelector('.amount').innerText = amount.toFixed(2);
        }
    });
</script>
{% endblock %}
